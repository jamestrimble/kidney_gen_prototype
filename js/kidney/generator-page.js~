$(document).foundation();

/*$.fn.serializeObject = function() {
  // http://stackoverflow.com/a/1186309
  var o = {};
  var a = this.serializeArray();
  $.each(a, function() {
    if (o[this.name] !== undefined) {
      if (!o[this.name].push) {
        o[this.name] = [o[this.name]];
      }
      o[this.name].push(this.value || '');
    } else {
      o[this.name] = this.value || '';
    }
  });
  return o;
};*/

$( "#generator-form" ).on( "submit", function( event ) {
  event.preventDefault();
  var genConfig = $( this ).serializeObject();
  ////console.log(genConfig);
  var gen = new KidneyGenerator(genConfig);
  var zip = new JSZip();
  
  $("#progress-message").text("Generating instance 0");
  setTimeout(function() {
    generateInstances(zip, gen, 0);
  }, 1);
});


var generateInstances = function(zip, gen, i) {
  var generatedDataset =
      gen.generateDataset(gen.patientsPerInstance, gen.proportionAltruistic);
  if (gen.fileFormat==="xml") {
    zip.file("genxml-" + i + ".xml", generatedDataset.toXmlString());
  } else if (gen.fileFormat==="json") {
    zip.file("genjson-" + i + ".json", generatedDataset.toJsonString());
  }

  if (++i < gen.numberOfInstances) {
    $("#progress-message").text("Generating instance " + i);
    setTimeout(function() {generateInstances(zip, gen, i)}, 1);
  } else {
    $("#progress-message").text("Creating zip file.");
    setTimeout(function() {
      var content = zip.generate({type:"blob"});
      saveAs(content, "generated.zip");
      $("#progress-message").text("Finished.");
    }, 1);
  }
};
